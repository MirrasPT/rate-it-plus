<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <title>Adicionar / Editar Item | Minha Coleção</title>
  <link rel="stylesheet" href="css/style.css" />

  <style>
    /* --- BG BLUR --- */
    .bg-blur{position:fixed;inset:0;background-size:cover;background-position:center;opacity:.25;filter:blur(20px);z-index:-1}

    /* --- LAYOUT --- */
    .form-window{max-width:1440px;margin:3rem auto;background:var(--card-bg);padding:2.5rem 2rem;border-radius:var(--radius);box-shadow:0 8px 32px rgba(0,0,0,.6);backdrop-filter:blur(8px);display:flex;flex-direction:column;gap:1.8rem}
    .form-header{display:flex;flex-direction:column;gap:.6rem;align-items:flex-start}
    .back-button{background:var(--card-glass);border:1px solid rgba(255,255,255,.2);padding:.25rem .8rem;border-radius:var(--radius);color:var(--text-light);cursor:pointer;font-size:.85rem}
    .form-header h1{font-size:2rem;margin:0;color:var(--accent2)}

    /* --- Secção de Pesquisa TMDB --- */
    .tmdb-search-section {
      background: rgba(255, 255, 255, 0.05);
      padding: 1rem;
      border-radius: var(--radius);
      margin-bottom: 1.5rem;
      border: 1px solid rgba(255, 255, 255, 0.1);
    }
    .tmdb-search-section h2 {
      margin-top: 0;
      margin-bottom: 0.8rem;
      font-size: 1.2rem;
      color: var(--accent);
    }
    .search-controls {
      display: flex;
      gap: 0.5rem;
      margin-bottom: 1rem;
    }
    .search-controls input[type="text"] {
      flex-grow: 1;
      padding: 0.55rem 0.8rem;
      border: 1px solid rgba(255, 255, 255, 0.2);
      border-radius: var(--radius);
      background: var(--card-glass);
      color: var(--text-light);
    }
    .search-controls button {
      padding: 0.55rem 1rem;
      border: none;
      border-radius: var(--radius);
      background: var(--accent);
      color: #000;
      cursor: pointer;
      transition: background var(--transition);
    }
    .search-controls button:hover {
      background: var(--accent2);
    }
    #tmdbSearchResults {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
      gap: 1rem;
      max-height: 400px; /* Altura máxima, com scroll se necessário */
      overflow-y: auto;
      padding: 0.5rem;
      background: rgba(0,0,0,0.2);
      border-radius: calc(var(--radius) - 4px);
    }
    .search-result-item {
      background: var(--card-glass);
      border-radius: var(--radius);
      padding: 0.5rem;
      text-align: center;
      cursor: pointer;
      transition: background var(--transition);
      border: 1px solid transparent;
    }
    .search-result-item:hover {
      background: rgba(255, 255, 255, 0.1);
      border-color: var(--accent);
    }
    .search-result-item img {
      width: 100%;
      aspect-ratio: 2/3;
      object-fit: cover;
      border-radius: calc(var(--radius) - 4px);
      margin-bottom: 0.5rem;
    }
    .search-result-item span {
      font-size: 0.8rem;
      color: var(--text-light);
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
      overflow: hidden;
      text-overflow: ellipsis;
    }
     .search-result-item .result-year {
      font-size: 0.7rem;
      color: var(--text-dark);
      display: block;
      margin-top: 0.2rem;
    }


    /* Grid do Formulário */
    .form-grid{display:grid;grid-template-columns:1fr 1fr;gap:1.2rem 2rem}
    .form-grid legend { /* Adicionado para títulos de secção do formulário */
      grid-column: 1 / -1;
      font-size: 1.1rem;
      color: var(--accent2);
      margin-top: 1rem;
      margin-bottom: 0.5rem;
      padding-bottom: 0.3rem;
      border-bottom: 1px solid var(--accent2);
    }
    .form-grid label{font-size:.9rem;margin-bottom:.3rem;display:block}
    .form-grid input,.form-grid textarea,.form-grid select{width:100%;padding:.55rem .8rem;border:1px solid rgba(255,255,255,.2);border-radius:var(--radius);background:var(--card-glass);color:var(--text-light);resize:vertical}
    textarea{min-height:100px}

    /* Chips (géneros + relacionados) */
    .chip-list{display:flex;flex-wrap:wrap;gap:.5rem}
    .chip{background:var(--card-glass);border:1px solid rgba(255,255,255,.2);padding:.35rem .9rem;border-radius:var(--radius);cursor:pointer;font-size:.85rem;user-select:none;transition:background var(--transition)}
    .chip.selected{background:var(--accent);color:#000}
    .chip .remove{margin-left:.4rem;cursor:pointer;font-weight:600}

    /* class grid */
    .grid-classificacoes{
      grid-column:1/-1;
      display:grid;
      grid-template-columns:repeat(4,1fr); /* 4 colunas */
      gap:1rem;
    }
    .grid-classificacoes div{
      display:flex;
      flex-direction:column; /* label por cima do input */
    }

    /* actions */
    .form-actions{display:flex;justify-content:flex-end;gap:1rem;grid-column:1/-1}
    .btn{padding:.6rem 1.4rem;border:none;border-radius:var(--radius);cursor:pointer;background:var(--card-glass);color:var(--text-light);transition:background var(--transition)}
    .btn-primary{background:var(--accent);color:#000}.btn-primary:hover{background:var(--accent2)}
  
  /* Estilos para controlar visibilidade das secções do formulário */
    .form-section {
      display: none; /* Oculta todas as secções por defeito */
      margin-bottom: 1.5rem; /* Adiciona algum espaço entre secções */
    }
    .form-section.active {
      display: block; /* Mostra a secção ativa */
    }
    /* Ajusta o layout da tmdb-search-section se necessário */
    .tmdb-search-section.active {
        display: block;
    }
    #btnAdicionarManualmenteContainer { /* Container para o botão de adicionar manualmente */
        margin-top: 1rem;
        text-align: center; /* Ou como preferires alinhar */
        display: none; /* Inicialmente oculto, será mostrado pelo JS */
    }
    #btnAdicionarManualmenteContainer.active {
        display: block;
    }
  /* ... (teus estilos existentes) ... */
.tmdb-summary-layout {
  display: flex;
  align-items: flex-start;
  gap: 1rem; /* Espaço entre poster e texto */
  padding: 0.5rem;
  background: rgba(255, 255, 255, 0.03); /* Um fundo subtil para o resumo */
  border-radius: var(--radius);
  border: 1px solid var(--card-glass);
}
#tmdbItemSummarySection legend { /* Estilo para o título da secção de resumo */
    font-size: 1.1rem;
    color: var(--accent); /* Usa uma cor de destaque diferente, se quiseres */
    margin-bottom: 0.8rem;
    padding-bottom: 0.3rem;
    border-bottom: 1px solid var(--accent);
}
  
  </style>
</head>
<body>
  <div class="bg-blur" id="bgBlur"></div>

  <div class="form-window">
    <div class="form-header">
      <button class="back-button" onclick="window.location.href='index.html'">← Voltar</button>
      <h1 id="formTitle">Adicionar Novo Item</h1>
    </div>

    <section class="tmdb-search-section active"> <h2>Pesquisar no TMDB</h2>
      
      <div class="search-controls">
        <input type="text" id="tmdbSearchQuery" placeholder="Ex: Inception, Breaking Bad...">
        <select id="tmdbSearchType">
          <option value="multi">Tudo</option>
          <option value="movie">Filmes</option>
          <option value="tv">Séries</option>
        </select>
        <button id="btnTmdbSearch">Pesquisar</button>
      </div>
      <div id="tmdbSearchResults">
        </div>
      <div id="btnAdicionarManualmenteContainer" class="active"> <p>Não encontraste o que procuras ou queres adicionar detalhes específicos?</p>
        <button type="button" class="btn" id="btnAdicionarManualmente">Adicionar Manualmente</button>
      </div>
    </section>

    <section id="tmdbItemSummarySection" class="form-section">
      <legend>Item Selecionado do TMDB</legend>
      <div class="tmdb-summary-layout"> <img id="summaryPoster" src="" alt="Poster" style="max-width: 100px; border-radius: var(--radius); margin-right: 1rem;"/>
        <div>
          <h3 id="summaryTitle" style="margin-top:0;"></h3>
          <p><strong >Ano:</strong> <span id="summaryYear"></span></p>
          <p><strong>Tipo:</strong> <span id="summaryType"></span></p>
          <p style="font-size: 0.85em; max-height: 100px; overflow-y: auto;"><em><span id="summarySinopse"></span></em></p>
        </div>
      </div>
      <hr style="margin: 1rem 0;">
    </section>

    <form id="itemForm">
      <input type="hidden" id="itemId" />
      <input type="hidden" id="tmdbId" />
      <input type="hidden" id="adicionadoManualmente" value="false" />

      <section id="detalhesItemSection" class="form-section">
        <legend>Detalhes do Item</legend>
        <div class="form-grid">
          <div style="grid-column:1/-1"><label for="urlImagem">URL da Capa</label><input type="url" id="urlImagem" /></div>
          <div style="grid-column:1/-1"><label for="nome">Título</label><input type="text" id="nome" required /></div>
          <div><label for="tipo">Tipo</label><select id="tipo" required><option value="Filme">Filme</option><option value="Série">Série</option></select></div>
          <div><label for="anoLancamento">Ano</label><input type="number" id="anoLancamento" min="1800" max="2100" /></div>
          <div style="grid-column:1/-1"><label for="trailerUrl">Trailer URL (opcional)</label><input type="url" id="trailerUrl" placeholder="https://youtu.be/..."/></div>
          <div style="grid-column:1/-1"><label for="idioma">Idioma Original (opcional)</label><input type="text" id="idioma" placeholder="Inglês"/></div>
          <div style="grid-column:1/-1">
            <label>Género(s)</label>
            <div class="chip-list" id="generoChips"></div>
          </div>
          <div style="grid-column:1/-1"><label for="sinopse">Sinopse</label><textarea id="sinopse"></textarea></div>
        </div>
      </section>

      <section id="avaliacaoSection" class="form-section">
        <legend>A Minha Avaliação</legend>
        <div class="form-grid">
            <div style="grid-column:1/-1">
                <label>Relacionados da Minha Coleção</label>
                <input list="titulosLista" id="relacionadoInput" placeholder="Pesquisar título na minha coleção…" autocomplete="off">
                <datalist id="titulosLista"></datalist>
                <div class="chip-list" id="relacionadosChips" style="margin-top:.6rem"></div>
            </div>
            <div style="grid-column:1/-1"><label for="review">Review Pessoal (opcional)</label><textarea id="review"></textarea></div>
            <div class="grid-classificacoes">
                <div><label for="historiaEnredo">História & Enredo</label><input type="number" id="historiaEnredo" min="0" max="10" step="0.1"></div>
                <div><label for="roteiroDialogos">Roteiro / Diálogos</label><input type="number" id="roteiroDialogos" min="0" max="10" step="0.1"></div>
                <div><label for="construcaoMundo">Construção de Mundo</label><input type="number" id="construcaoMundo" min="0" max="10" step="0.1"></div>
                <div><label for="desenvolvimentoPersonagens">Personagens</label><input type="number" id="desenvolvimentoPersonagens" min="0" max="10" step="0.1"></div>
                <div><label for="musica">Música</label><input type="number" id="musica" min="0" max="10" step="0.1"></div>
                <div><label for="efeitosSonoros">Efeitos Sonoros</label><input type="number" id="efeitosSonoros" min="0" max="10" step="0.1"></div>
                <div><label for="artesVisuais">Artes Visuais</label><input type="number" id="artesVisuais" min="0" max="10" step="0.1"></div>
                <div><label for="impactoEmocional">Impacto Emocional</label><input type="number" id="impactoEmocional" min="0" max="10" step="0.1"></div>
                <div><label for="originalidade">Originalidade</label><input type="number" id="originalidade" min="0" max="10" step="0.1"></div>
                <div><label for="ritmo">Ritmo</label><input type="number" id="ritmo" min="0" max="10" step="0.1"></div>
                <div><label for="humor">Humor</label><input type="number" id="humor" min="0" max="10" step="0.1"></div>
                <div><label for="adaptacaoRemake">Adaptação/Remake (opcional)</label><input type="number" id="adaptacaoRemake" min="0" max="10" step="0.1"></div>
            </div>
        </div>
      </section>
      
      <section id="formActionsSection" class="form-section">
         <div class="form-actions">
            <button type="submit" class="btn btn-primary" id="btnSalvar">Adicionar</button>
            <button type="button" class="btn" id="btnLimparForm">Limpar Tudo</button>
            <button type="button" class="btn" id="btnCancelar">Cancelar</button>
        </div>
      </section>
    </form>
  </div>

  <script src="js/dataManager.js"></script>
  <script src="js/apiService.js"></script> 
  <script src="js/formHandler.js"></script>
  <script>
    const btnCancelarForm = document.getElementById('btnCancelar');
    if (btnCancelarForm) {
      btnCancelarForm.onclick = () => history.back();
    }
  </script>
</body>
</html>